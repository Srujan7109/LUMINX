<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login / Sign Up</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container d-flex justify-content-center align-items-center vh-100">
  <div class="card shadow p-4" style="width: 400px;">
    <h3 class="text-center mb-3" id="formTitle">Login</h3>

    <!-- Error/Success Messages -->
    <div id="messageDiv" class="alert d-none" role="alert"></div>

    <!-- Auth Form -->
    <form id="authForm">
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input type="text" id="username" class="form-control" required>
      </div>

      <div class="mb-3" id="fullNameDiv">
        <label class="form-label">Full Name</label>
        <input type="text" id="fullName" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">Password</label>
        <input type="password" id="password" class="form-control" required>
      </div>

      <div class="mb-3" id="roleDiv">
        <label class="form-label">Role</label>
        <select id="role" class="form-select">
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>
      </div>

      <button type="submit" class="btn btn-success w-100" id="submitBtn">Login</button>
    </form>

    <p class="text-center mt-3">
      <span id="toggleText">Not registered?</span>
      <a href="#" id="toggleLink">Sign Up</a>
    </p>
  </div>
</div>

<script>
/*
  Behavior:
   - Signup sends POST /api/users/create  { username, fullName, password, role }
   - Login sends POST /api/users/login    { username, password }
   - No client-side storage. On login success we redirect to:
       /dashboard?username=<username>
     (dashboard should fetch user info from /api/users/:username)
*/

let isLogin = true;

const formTitle = document.getElementById("formTitle");
const authForm = document.getElementById("authForm");
const submitBtn = document.getElementById("submitBtn");
const toggleText = document.getElementById("toggleText");
const toggleLink = document.getElementById("toggleLink");
const messageDiv = document.getElementById("messageDiv");
const fullNameDiv = document.getElementById("fullNameDiv");
const roleDiv = document.getElementById("roleDiv");

function showMessage(message, type = "danger") {
  messageDiv.textContent = message;
  messageDiv.className = `alert alert-${type}`;
  messageDiv.classList.remove("d-none");
}
function hideMessage() {
  messageDiv.classList.add("d-none");
}

// Initially: hide fullName and role for Login
function updateFormUI() {
  if (isLogin) {
    formTitle.textContent = "Login";
    submitBtn.textContent = "Login";
    toggleText.textContent = "Not registered?";
    toggleLink.textContent = "Sign Up";
    fullNameDiv.style.display = "none";
    roleDiv.style.display = "none";
    document.getElementById("fullName").required = false;
  } else {
    formTitle.textContent = "Sign Up";
    submitBtn.textContent = "Sign Up";
    toggleText.textContent = "Already have an account?";
    toggleLink.textContent = "Login";
    fullNameDiv.style.display = "block";
    roleDiv.style.display = "block";
    document.getElementById("fullName").required = true;
  }
}
updateFormUI();

toggleLink.addEventListener("click", (e) => {
  e.preventDefault();
  hideMessage();
  isLogin = !isLogin;
  updateFormUI();
});

authForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMessage();

  const username = document.getElementById("username").value.trim();
  const fullName = document.getElementById("fullName").value.trim();
  const password = document.getElementById("password").value;
  const role = document.getElementById("role").value;

  // Basic validation
  if (!username || !password) {
    showMessage("Please provide username and password.");
    return;
  }
  if (!isLogin && !fullName) {
    showMessage("Please provide your full name for sign up.");
    return;
  }

  // Decide endpoint: create (signup) or login
  const endpoint = isLogin ? "login" : "create"; // IMPORTANT: backend should use /api/users/create and /api/users/login

  // Build request body depending on action
  const body = isLogin
    ? { username, password }
    : { username, fullName, password, role };

  try {
    submitBtn.disabled = true;
    submitBtn.textContent = isLogin ? "Logging in..." : "Signing up...";

    // Use a relative URL so it works on any host/port that serves the frontend
    const res = await fetch(`/api/users/${endpoint}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    console.log("Server response:", data);

    if (res.ok) {
      if (isLogin) {
        // Expecting: { message: "...", user: { username, fullName, role } }
        showMessage(`Welcome ${data.user.fullName}! Redirecting...`, "success");

        // Redirect to dashboard and pass username via query param (no client storage)
        const target = `/dashboard?username=${encodeURIComponent(data.user.username)}`;
        setTimeout(() => { window.location.href = target; }, 900);

      } else {
        // Signup successful
        showMessage("Sign up successful! Please log in.", "success");
        // reset and switch to login
        authForm.reset();
        setTimeout(() => {
          isLogin = true;
          updateFormUI();
        }, 1200);
      }
    } else {
      // Show useful message from backend
      const errMsg = data.error || data.message || (data.validationErrors ? Object.values(data.validationErrors).join(", ") : "Server error");
      showMessage(errMsg, "danger");
    }
  } catch (err) {
    console.error("Request error:", err);
    showMessage("Unable to reach server. Is the backend running?");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = isLogin ? "Login" : "Sign Up";
  }
});
</script>

</body>
</html>


